name: Scrape Cotes BoostÃ©es Winamax

on:
  schedule:
    # Toutes les 30 minutes avec dÃ©calage de 5 minutes
    # Format: minute heure jour mois jour_semaine
    # 5,35 * * * * = Ã  5 et 35 minutes de chaque heure
    - 
  
  # Permet de lancer manuellement depuis l'interface GitHub
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Install system dependencies (for OCR)
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          tesseract-ocr \
          tesseract-ocr-fra \
          libtesseract-dev \
          libgl1 \
          libglib2.0-0
    
    - name: ğŸ“š Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ• Display current time
      run: |
        echo "â° Heure de dÃ©marrage: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸŒ Timezone: $(timedatectl show --property=Timezone --value)"
    
    - name: ğŸ¤– Run scraper (Selenium - stable et fiable)
      run: |
        python main.py --method selenium --export all
      continue-on-error: true
    
    - name: ğŸ“Š Display results summary
      if: always()
      run: |
        echo "ğŸ“ˆ RÃ©sumÃ© du scraping:"
        if [ -d "output/json" ]; then
          echo "ğŸ“ Fichiers JSON:"
          ls -lh output/json/ | tail -n +2 || echo "  Aucun fichier"
        fi
        if [ -d "output/csv" ]; then
          echo "ğŸ“ Fichiers CSV:"
          ls -lh output/csv/ | tail -n +2 || echo "  Aucun fichier"
        fi
        if [ -d "output/screenshots" ]; then
          echo "ğŸ“ Screenshots:"
          ls -lh output/screenshots/ | tail -n +2 || echo "  Aucun fichier"
        fi
    
    - name: ğŸ’¾ Commit and push results
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Ajouter tous les fichiers de sortie
        git add output/ || true
        
        # VÃ©rifier s'il y a des changements
        if git diff --staged --quiet; then
          echo "âœ… Aucun changement Ã  commit"
        else
          # CrÃ©er un commit avec timestamp
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
          git commit -m "ğŸ¤– Scraping auto: $TIMESTAMP"
          git push
          echo "âœ… RÃ©sultats pushÃ©s vers GitHub"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ“¤ Upload artifacts (backup si Ã©chec)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: scraping-results-${{ github.run_number }}
        path: output/
        retention-days: 7
    
    - name: ğŸ”” Notify on failure
      if: failure()
      run: |
        echo "âŒ Le scraping a Ã©chouÃ© Ã  $(date '+%Y-%m-%d %H:%M:%S')"
        echo "VÃ©rifiez les logs ci-dessus pour plus de dÃ©tails"
